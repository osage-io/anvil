#!/usr/bin/env bash
set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a Go project
if [ ! -f "go.mod" ]; then
    echo "âŒ Not a Go project (no go.mod found)"
    exit 1
fi

# 1. Format check
echo "  â€¢ Checking Go formatting..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo "âŒ The following files need formatting:"
    echo "$UNFORMATTED"
    echo "Run: gofmt -w ."
    exit 1
fi
echo "    âœ… Code is properly formatted"

# 2. Go vet
echo "  â€¢ Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet failed"
    exit 1
fi
echo "    âœ… go vet passed"

# 3. golangci-lint (if available)
if command -v golangci-lint > /dev/null; then
    echo "  â€¢ Running golangci-lint..."
    if ! golangci-lint run --timeout=2m; then
        echo "âŒ golangci-lint failed"
        exit 1
    fi
    echo "    âœ… golangci-lint passed"
else
    echo "    âš ï¸  golangci-lint not found, skipping (consider installing: https://golangci-lint.run/usage/install/)"
fi

# 4. Fast unit tests (short tests only)
echo "  â€¢ Running fast unit tests..."
if ! go test -short -race ./internal/...; then
    echo "âŒ Fast unit tests failed"
    exit 1
fi
echo "    âœ… Fast unit tests passed"

echo "âœ… All pre-commit checks passed!"
